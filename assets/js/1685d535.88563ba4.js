"use strict";(globalThis.webpackChunkrock_docs=globalThis.webpackChunkrock_docs||[]).push([[54],{3134(e,n,i){i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"References/model-service","title":"Model Service","description":"Model Service is an important component in the Self-ROCK framework that handles communication for AI model calls, providing a communication bridge between the Agent and Runtime (Roll).","source":"@site/versioned_docs/version-1.0.x/References/model-service.md","sourceDirName":"References","slug":"/References/model-service","permalink":"/ROCK/docs/1.0.x/References/model-service","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROCK/tree/master/docs/rock/versioned_docs/version-1.0.x/References/model-service.md","tags":[],"version":"1.0.x","lastUpdatedAt":1767507181000,"sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"API Reference","permalink":"/ROCK/docs/1.0.x/References/api"},"next":{"title":"Sandbox Agent","permalink":"/ROCK/docs/1.0.x/References/sandbox-agent"}}');var l=i(4848),r=i(8453);const o={sidebar_position:2},c="Model Service",d={},t=[{value:"Architecture Overview",id:"architecture-overview",level:2},{value:"Core Components",id:"core-components",level:2},{value:"1. ModelService",id:"1-modelservice",level:3},{value:"2. ModelClient",id:"2-modelclient",level:3},{value:"3. Configuration",id:"3-configuration",level:3},{value:"API Interface",id:"api-interface",level:2},{value:"Local API (<code>/v1/chat/completions</code>)",id:"local-api-v1chatcompletions",level:3},{value:"Health Check (<code>/health</code>)",id:"health-check-health",level:3},{value:"Proxy API",id:"proxy-api",level:3},{value:"CLI Commands",id:"cli-commands",level:2},{value:"start command",id:"start-command",level:3},{value:"watch-agent command",id:"watch-agent-command",level:3},{value:"stop command",id:"stop-command",level:3},{value:"anti-call-llm command",id:"anti-call-llm-command",level:3},{value:"File Communication Protocol",id:"file-communication-protocol",level:2},{value:"Request Format",id:"request-format",level:3},{value:"Response Format",id:"response-format",level:3},{value:"Session End Marker",id:"session-end-marker",level:3},{value:"Sandbox Integration",id:"sandbox-integration",level:2},{value:"ModelServiceConfig",id:"modelserviceconfig",level:3},{value:"ModelService Class",id:"modelservice-class",level:3},{value:"Workflow",id:"workflow",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"Service Configuration",id:"service-configuration",level:3},{value:"Log Configuration",id:"log-configuration",level:3},{value:"Polling Configuration",id:"polling-configuration",level:3},{value:"Marker Configuration",id:"marker-configuration",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"model-service",children:"Model Service"})}),"\n",(0,l.jsx)(n.p,{children:"Model Service is an important component in the Self-ROCK framework that handles communication for AI model calls, providing a communication bridge between the Agent and Runtime (Roll)."}),"\n",(0,l.jsx)(n.h2,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,l.jsx)(n.p,{children:"The model service uses the file system as a communication medium to implement the request-response mechanism between the agent and the model. When an agent needs to call a model, the request is first written to the log file, then processed by the listening component. When the model generates a response, the result is written back to the log file and read by the waiting agent."}),"\n",(0,l.jsx)(n.h2,{id:"core-components",children:"Core Components"}),"\n",(0,l.jsx)(n.h3,{id:"1-modelservice",children:"1. ModelService"}),"\n",(0,l.jsxs)(n.p,{children:["Located in ",(0,l.jsx)(n.code,{children:"rock/sdk/model/service.py"}),", responsible for service lifecycle management:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Start model service (local or proxy mode)"}),"\n",(0,l.jsx)(n.li,{children:"Monitor agent processes"}),"\n",(0,l.jsx)(n.li,{children:"Stop model service"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"2-modelclient",children:"2. ModelClient"}),"\n",(0,l.jsxs)(n.p,{children:["Located in ",(0,l.jsx)(n.code,{children:"rock/sdk/model/client.py"}),", provides client functionality for communicating with the model service:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Push model responses to the system"}),"\n",(0,l.jsx)(n.li,{children:"Retrieve new requests from the system"}),"\n",(0,l.jsx)(n.li,{children:"Manage request/response indexing to maintain order"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"3-configuration",children:"3. Configuration"}),"\n",(0,l.jsxs)(n.p,{children:["Located in ",(0,l.jsx)(n.code,{children:"rock/sdk/model/server/config.py"}),", defines the service configuration parameters:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Service host and port (default 8080)"}),"\n",(0,l.jsx)(n.li,{children:"Log file path"}),"\n",(0,l.jsx)(n.li,{children:"Request and response marker strings"}),"\n",(0,l.jsx)(n.li,{children:"Polling interval and other parameters"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"api-interface",children:"API Interface"}),"\n",(0,l.jsxs)(n.h3,{id:"local-api-v1chatcompletions",children:["Local API (",(0,l.jsx)(n.code,{children:"/v1/chat/completions"}),")"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Method"}),": POST"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Description"}),": OpenAI-compatible chat completion endpoint"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Functionality"}),":","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Process streaming and non-streaming requests"}),"\n",(0,l.jsx)(n.li,{children:"Write requests to log file"}),"\n",(0,l.jsx)(n.li,{children:"Listen for and return responses from runtime"}),"\n",(0,l.jsx)(n.li,{children:"Throw exception if no response is found"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.h3,{id:"health-check-health",children:["Health Check (",(0,l.jsx)(n.code,{children:"/health"}),")"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Method"}),": GET"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Description"}),": Health check endpoint for verifying service status"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"proxy-api",children:"Proxy API"}),"\n",(0,l.jsxs)(n.p,{children:["The current proxy API (",(0,l.jsx)(n.code,{children:"/v1/chat/completions"}),") is not yet implemented"]}),"\n",(0,l.jsx)(n.h2,{id:"cli-commands",children:"CLI Commands"}),"\n",(0,l.jsxs)(n.p,{children:["The model service provides a set of CLI commands accessible through ",(0,l.jsx)(n.code,{children:"rock model-service"}),":"]}),"\n",(0,l.jsx)(n.h3,{id:"start-command",children:"start command"}),"\n",(0,l.jsx)(n.p,{children:"Start the model service process"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"rock model-service start --type [local|proxy]\n"})}),"\n",(0,l.jsx)(n.p,{children:"Parameters:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"--type"}),": Model service type, can be ",(0,l.jsx)(n.code,{children:"local"})," or ",(0,l.jsx)(n.code,{children:"proxy"}),", default is ",(0,l.jsx)(n.code,{children:"local"})]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"watch-agent-command",children:"watch-agent command"}),"\n",(0,l.jsx)(n.p,{children:"Monitor the agent process, send SESSION_END message when the process exits"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"rock model-service watch-agent --pid <process ID>\n"})}),"\n",(0,l.jsx)(n.p,{children:"Parameters:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"--pid"}),": Agent process ID to monitor"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"stop-command",children:"stop command"}),"\n",(0,l.jsx)(n.p,{children:"Stop the model service"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"rock model-service stop\n"})}),"\n",(0,l.jsx)(n.h3,{id:"anti-call-llm-command",children:"anti-call-llm command"}),"\n",(0,l.jsx)(n.p,{children:"Anti-call LLM interface"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"rock model-service anti-call-llm --index <index> [--response <response>]\n"})}),"\n",(0,l.jsx)(n.p,{children:"Parameters:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"--index"}),": Index of the last LLM call, starting from 0"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"--response"}),": Response from the last LLM call (optional)"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"file-communication-protocol",children:"File Communication Protocol"}),"\n",(0,l.jsx)(n.p,{children:"The model service uses files for inter-process communication and defines specific marker formats for distinguishing between requests and responses:"}),"\n",(0,l.jsx)(n.h3,{id:"request-format",children:"Request Format"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"LLM_REQUEST_START{JSON request data}LLM_REQUEST_END{Metadata JSON}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"response-format",children:"Response Format"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"LLM_RESPONSE_START{JSON response data}LLM_RESPONSE_END{Metadata JSON}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"session-end-marker",children:"Session End Marker"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"SESSION_END\n"})}),"\n",(0,l.jsx)(n.p,{children:"Metadata includes timestamp and index information to ensure message order and processing."}),"\n",(0,l.jsx)(n.h2,{id:"sandbox-integration",children:"Sandbox Integration"}),"\n",(0,l.jsx)(n.h3,{id:"modelserviceconfig",children:"ModelServiceConfig"}),"\n",(0,l.jsxs)(n.p,{children:["Located in ",(0,l.jsx)(n.code,{children:"rock/sdk/sandbox/model_service/base.py"}),", defines the model service configuration in the sandbox:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Working directory"}),"\n",(0,l.jsx)(n.li,{children:"Python and model service installation commands"}),"\n",(0,l.jsx)(n.li,{children:"Session environment variables"}),"\n",(0,l.jsx)(n.li,{children:"Various command templates"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"modelservice-class",children:"ModelService Class"}),"\n",(0,l.jsx)(n.p,{children:"Manages the model service lifecycle within the sandbox:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"install()"}),": Install model service dependencies in the sandbox"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"start()"}),": Start the model service"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"stop()"}),": Stop the model service"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"watch_agent()"}),": Monitor agent processes"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"anti_call_llm()"}),": Execute anti-call LLM operation"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"workflow",children:"Workflow"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Agent initiates model call request"}),"\n",(0,l.jsx)(n.li,{children:"Request is formatted and written to log file"}),"\n",(0,l.jsx)(n.li,{children:"Model service listens to log file and captures new requests"}),"\n",(0,l.jsx)(n.li,{children:"Runtime (Roll) processes the request and generates a response"}),"\n",(0,l.jsx)(n.li,{children:"Response is written to log file"}),"\n",(0,l.jsx)(n.li,{children:"Model service returns the response to the agent"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,l.jsx)(n.h3,{id:"service-configuration",children:"Service Configuration"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SERVICE_HOST"}),': Service host address, default is "0.0.0.0"']}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SERVICE_PORT"}),": Service port, default is 8080"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"log-configuration",children:"Log Configuration"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"LOG_FILE"}),": Log file path containing request and response data"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"polling-configuration",children:"Polling Configuration"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"POLLING_INTERVAL_SECONDS"}),": Polling interval, default is 0.1 seconds"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"REQUEST_TIMEOUT"}),": Request timeout, default is infinite"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"marker-configuration",children:"Marker Configuration"}),"\n",(0,l.jsx)(n.p,{children:"Defines markers for distinguishing different message types in the log file:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"REQUEST_START_MARKER"})," / ",(0,l.jsx)(n.code,{children:"REQUEST_END_MARKER"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"RESPONSE_START_MARKER"})," / ",(0,l.jsx)(n.code,{children:"RESPONSE_END_MARKER"})]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"SESSION_END_MARKER"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},8453(e,n,i){i.d(n,{R:()=>o,x:()=>c});var s=i(6540);const l={},r=s.createContext(l);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);